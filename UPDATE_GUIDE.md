# Руководство по обновлению веб-приложения "studio" на сервере

## Пошаговая инструкция обновления (интерактивный режим)

### Шаг 1. Подготовка

1. Откройте терминал на вашей локальной машине в директории проекта.
2. Проверьте, что все изменения закоммичены и протестированы.
3. Подключение к серверу по SSH:

   **Пошаговая инструкция для Windows:**
   1. Нажмите клавишу Win (или кнопку "Пуск") на клавиатуре.
   2. Введите `cmd` и нажмите Enter — откроется "Командная строка" (черное окно).
   3. В открывшемся окне напечатайте команду:
      ```
      ssh deployuser@157.180.87.32
      ```
      и нажмите Enter.
   4. Если появится вопрос "Are you sure you want to continue connecting (yes/no/[fingerprint])?" — напечатайте `yes` и нажмите Enter.
   5. Если всё настроено правильно, вы увидите приглашение сервера (например, `deployuser@studio-app-server:~$`).

   **Пошаговая инструкция для MacOS/Linux:**
   1. Откройте приложение "Терминал" (обычно через поиск Spotlight или меню приложений).
   2. Введите команду:
      ```
      ssh deployuser@157.180.87.32
      ```
      и нажмите Enter.
   3. Дальнейшие шаги аналогичны Windows.

4. Проверка актуальности файла .env на сервере:

   - После подключения к серверу выполните по одной команде (скопируйте каждую строку по очереди и вставьте в терминал):

   ```bash
   cd /var/www/studio_app
   ```

   ```bash
   cat .env
   ```

   - Сравните вывод с актуальными переменными вашего проекта.
   - Чтобы отредактировать файл, выполните:

   ```bash
   nano .env
   ```

   - После редактирования:
     - Для выхода из nano нажмите Ctrl+X
     - Затем Y (Yes)
     - Затем Enter

**Выполняйте команды по одной строке. Сообщите, если всё готово или возникли трудности.**

---

### Шаг 2. Проверка скрипта обновления

1. Проверьте наличие файла `scripts/deploy.sh` в проекте.
2. Сделайте скрипт исполняемым (однократно):

   ```bash
   chmod +x scripts/deploy.sh
   ```

3. Сообщите, выполнено ли это действие или возникли трудности.

---

### Шаг 3. Запуск автоматического обновления

1. Запустите скрипт обновления:

   ```bash
   ./scripts/deploy.sh
   ```

2. Следите за выводом в терминале. Если появятся ошибки — скопируйте их и сообщите.
3. После завершения скрипта убедитесь, что приложение работает на сервере.

**Пример вывода:**
- Если видите сообщения вроде `Процесс обновления приложения на сервере успешно завершен.` — обновление прошло успешно.
- Если появляются ошибки (например, `relation "users" already exists` или `Cannot stat: No such file or directory`), зафиксируйте их текст ниже и обратитесь к разделу "Возможные проблемы и решения".

**Сообщите о результате выполнения этого шага.**

---

### Шаг 4. Проверка результата

1. Откройте приложение в браузере по адресу:  
   `http://157.180.87.32:3000`
2. Проверьте, что все основные функции работают корректно.
3. Если страница не открывается — попробуйте другой браузер или устройство (иногда проблема связана с кэшем или прокси).
4. Если сайт открывается только в другом браузере — очистите кэш или используйте рабочий браузер для дальнейшей работы.
5. Если есть другие проблемы — опишите их и приложите логи.

---

### Шаг 5. Документирование

- После каждого шага фиксируйте результат (успех/ошибка, особенности) в этом файле.
- Если возникли трудности — опишите их и решения.

---

## Пример успешного обновления

- Все шаги выполнены по инструкции.
- Ошибка "Failed to fetch projects from API" устранена после добавления столбца price в таблицу orders.
- После перезапуска приложения и проверки API данные успешно возвращаются.
- В браузере страница /projects открывается и отображает проекты.
- Обновления работают как на локальной машине, так и на сервере.

---

## Важные замечания

- **.env**: Не включайте файл .env в архив! Все секреты должны храниться только на сервере.
- **Миграции**: Если миграция уже была применена вручную, удалите или переименуйте соответствующий файл миграции, чтобы избежать ошибок "column already exists".
- **Архив**: После обновления архив автоматически удаляется на сервере и локально.
- **Ошибки**: При ошибках сборки, копирования или миграций скрипт завершится с ошибкой и выведет причину.

## Возможные проблемы и решения

- **Ошибка миграции**: Если поле уже существует — удалите или отметьте миграцию как выполненную.
- **Проблемы с зависимостями**: Убедитесь, что package.json и package-lock.json актуальны.
  - При ошибке `ERESOLVE` используйте флаг `--legacy-peer-deps`: `npm install --legacy-peer-deps`
  - Особое внимание к пакетам Tiptap (сейчас используются две версии: 2.x и 3.x)
- **Проблемы с SSH**: Проверьте настройки ключей и права доступа.
- **Проблемы с правами доступа**:
  - При ошибках `EACCES` используйте `sudo` для команд или измените владельца файлов: `sudo chown -R deployuser:deployuser /var/www/studio_app`
- **Ошибка 500 после обновления**:
  - Проверьте логи с помощью `pm2 logs studio-app`
  - Типичные ошибки: несоответствие структуры базы данных и модели, проблемы с клиентскими модулями
  - Попробуйте перезапустить приложение: `pm2 reload studio-app`
  - В крайнем случае восстановите из резервной копии: `sudo cp -r studio_app_backup_YYYYMMDD studio_app`

## Безопасность

- Не храните секретные данные в репозитории.
- Используйте только защищённые соединения для деплоя.

## История изменений

- 2025-06-02: Обновлено руководство с информацией о часто встречающихся проблемах и их решениях.
- Фиксируйте все изменения и особенности обновления в этом файле для будущих администраторов.

## Рекомендуемая процедура обновления

### 1. Подготовка и резервное копирование

```bash
# 1. Подключиться к серверу
ssh deployuser@157.180.87.32

# 2. Создать резервную копию
cd /var/www
sudo cp -r studio_app studio_app_backup_$(date +%Y%m%d)
```

### 2. Подготовка обновления на локальной машине

```bash
# 1. Собрать проект локально
npm run build

# 2. Создать архив (исключить node_modules, .env и .git)
tar --exclude='node_modules' --exclude='.env' --exclude='.git' -czvf studio_app.tar.gz .
```

### 3. Копирование и обновление на сервере

```bash
# 1. Копировать архив на сервер
scp studio_app.tar.gz deployuser@157.180.87.32:/home/deployuser/

# 2. На сервере остановить приложение
ssh deployuser@157.180.87.32
pm2 stop studio-app

# 3. Распаковать архив
cd ~
sudo rm -rf /var/www/studio_app/.next
sudo tar -xzvf studio_app.tar.gz -C /var/www/studio_app --strip-components=0

# 4. Установить зависимости
cd /var/www/studio_app
sudo npm install --legacy-peer-deps

# 5. Запустить миграции (только для новых миграций)
# Проверить наличие новых файлов миграций

# 6. Запустить приложение
pm2 start studio-app
pm2 save
```

### 4. Проверка и откат при необходимости

```bash
# Проверить работу приложения
# Если есть ошибки, проверить логи
pm2 logs studio-app

# В случае серьезных проблем - восстановить из резервной копии
pm2 stop studio-app
pm2 delete studio-app
cd /var/www
sudo rm -rf studio_app
sudo cp -r studio_app_backup_YYYYMMDD studio_app
cd studio_app
pm2 start npm --name "studio-app" -- run start
pm2 save
```

**Важно:** На каждом этапе фиксируйте успехи/проблемы, обновляйте инструкцию и создавайте скрипты для автоматизации.
